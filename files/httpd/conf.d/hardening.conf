# --- deny list (keep as needed) ---

# uncomment block if you want to ban specific ips
#<Location "/">
#  <RequireAll>
#    Require all granted
#    <RequireNone>
#      Require ip 100.27.42.244
#  </RequireAll>
#</Location>

# Close common scanner paths
RedirectMatch 403 (?i)^/(cgi-bin|scripts|_vti_bin|_private|_backup|vendor|actuator)/

# Front-door timeouts (snappy keep-alives)
Timeout 30
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 1
RequestReadTimeout header=10-20,MinRate=500 body=10,MinRate=500
HostnameLookups Off

# Size caps (avoid header/body abuse)
LimitRequestBody 10485760
LimitRequestFields 100
LimitRequestFieldSize 16384

# If any content is on NFS, keep these; harmless otherwise
EnableSendfile Off
EnableMMAP Off

# --- Event MPM: fixed, modest concurrency & no churn ---
<IfModule mpm_event_module>
    ServerLimit            6
    ThreadsPerChild       25
    MaxRequestWorkers    150
    StartServers           2
    MinSpareThreads       25
    MaxSpareThreads       75
    MaxConnectionsPerChild 0
    ListenBacklog       1024
    GracefulShutdownTimeout 10
</IfModule>

# --- PHP-FPM: only pass EXISTING .php files; fast timeouts ---
RewriteEngine On
RewriteCond %{REQUEST_FILENAME} \.php$ [NC]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^ - [F]

ProxyTimeout 30
ProxyBadHeader Ignore
ProxyErrorOverride Off

# --- Spam stopper for /us3_gridctl/search and /openAUC/search ---
RewriteEngine On

# 1) Block if q= points to an external URL (plain or encoded 1x/2x)
#    Matches: http://  https://  http%3a%2f%2f  https%253a%252f%252f
RewriteCond %{REQUEST_URI} ^/(us3_gridctl|openAUC)/search$ [NC]
RewriteCond %{QUERY_STRING} (?i)(^|&)q=([^&]*)(%25)?https?(%3a|:)(%2f|/){2}
RewriteRule ^ - [F]

# 2) (Optional) Also block if q= contains "://" anywhere (extra belt)
RewriteCond %{REQUEST_URI} ^/(us3_gridctl|openAUC)/search$ [NC]
RewriteCond %{QUERY_STRING} (?i)(^|&)q=[^&]*(%3a%2f%2f|%253a%252f%252f|://)
RewriteRule ^ - [F]

# 3) (Optional) Drop absurdly long query strings on these endpoints (DoS guard)
RewriteCond %{REQUEST_URI} ^/(us3_gridctl|openAUC)/search$ [NC]
RewriteCond %{THE_REQUEST} \?
RewriteCond %{QUERY_STRING} .{1200,}
RewriteRule ^ - [F]

<FilesMatch "\.php$">
    SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost/"
</FilesMatch>

<Proxy "fcgi://localhost/">
    ProxySet connectiontimeout=5 timeout=30 acquire=300 retry=0
</Proxy>

# Local-only status page for quick checks
ExtendedStatus On
<Location "/server-status">
    SetHandler server-status
    Require local
</Location>

